#!/bin/bash

# collect arguments,
# prepend them with command name and current directory

args=`pwd`
args+='\n%name%'

for arg in "$@"
do 
    args+='\narg='
    args+=$arg
done
# add empty line
args+='\n\n'
# add env vars (spaces added not send empty lines)
args+=$SVN_EDITOR
args+=' \n'
args+=$SVN_MERGE
args+=' \n'
args+=$SVNTEST_EDITOR_FUNC
args+=' \n'
args+=$SVN_I_LOVE_CORRUPTED_WORKING_COPIES_SO_DISABLE_SLEEP_FOR_TIMESTAMPS
# add empty line
args+=' \n\n'

# check input
if [ ! -t 0 ]
   then
    args+=`cat<&0`
fi
args+='\n\0'

# now send all that to the server

exec 3<>/dev/tcp/localhost/%port%
echo -e -n "$args">&3
data=$(cat <&3)

# process data with simple regexps

data1=${data%%\$\$\$*\$\$\$*}
data2=${data:${#data1}}
rc=${data2##\$\$\$*\$\$\$}
data2=${data2%\$\$\$[[:digit:]]}
data2=${data2:3}

echo -n "$data1"
echo -n "$data2">&2
exit $rc
