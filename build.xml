<?xml version="1.0" encoding="UTF-8"?>
<project name="javasvn" default="help" basedir=".">	
	
	<target name="init">
        <property environment="env"/>		
        <property name="eclipse.home" value="${env.ECLIPSE_HOME}"/>
        <property name="java.home" value="${env.JAVA_HOME}"/>
        
		<tstamp>
		      <format property="date" pattern="yyyyMMdd"/>
		</tstamp>

		<condition property="os" value="windows"><os family="dos"/></condition>
		<condition property="os" value="unix"><os family="unix"/></condition>
		<condition property="os" value="mac"><os family="mac"/></condition>
	</target>
	
	<target name="clean" depends="init">
		<delete dir="javasvn/bin" failonerror="false" />
		<delete dir="javasvn-test/bin" />
		<delete dir="javasvn-eclipse/bin" failonerror="false" />
		<delete dir="javasvn-eclipse/plugin" failonerror="false" />
		<delete dir="javasvn-test/svn-config/auth" failonerror="false" />
		<delete dir="contrib/sequence/bin" failonerror="false" />
		<delete dir="contrib/javahl/bin" failonerror="false" />

		<delete dir="lib" failonerror="false" />
		<delete dir="doc" failonerror="true" />

		<delete failonerror="false" >
			<fileset dir="." includes="org**"/>
		</delete>
		
		<copy file="javasvn-test/test.${os}.properties" tofile="javasvn-test/test.properties" 
			failonerror="false" overwrite="false"/>
        </target>

	<target name="build-standalone" depends="init">
		<mkdir dir="javasvn/bin" />
		<mkdir dir="contrib/sequence/bin" />
		<mkdir dir="contrib/javahl/bin" />
		
		<javac debug="true" classpath="contrib/junit/junit.jar"	destdir="contrib/sequence/bin">
			<src path="contrib/sequence/src"/>
		</javac>
		<javac debug="true" destdir="contrib/javahl/bin" excludes="**/tests/**">
			<src path="contrib/javahl/src" />
		</javac>
		<javac classpath="contrib/sequence/bin;contrib/javahl/bin;contrib/jsch/jsch-0.1.18.jar" debug="true" destdir="javasvn/bin">
			<src path="javasvn/src"/>
		</javac>
		<!--
		<javac debug="true" classpath="contrib/sequence/bin;contrib/junit/junit.jar" destdir="contrib/sequence/bin-test">
			<src path="contrib/sequence/src-test"/>
		</javac>
		<javac classpath="javasvn/bin;contrib/junit/junit.jar" debug="true" destdir="javasvn-test/bin">
			<src path="javasvn-test/src"/>
		</javac>
		-->
		<!-- build main library jar file -->
		<mkdir dir="lib"/>
		<jar destfile="lib/javasvn.jar">
			<fileset dir="javasvn/bin">
			    <include name="**"/>
			    <exclude name="org/tmatesoft/svn/cli/**"/>
			</fileset>
			<fileset dir="contrib/sequence/bin">
			    <include name="**"/>
			</fileset>
			<fileset dir="contrib/javahl/bin">
			    <include name="**"/>
			    <exclude name="**/SVNClient.class"/>
			    <exclude name="**/SVNClient$LogLevel.class"/>
			</fileset>
		</jar>
		<jar destfile="lib/javasvn-cli.jar">
			<fileset dir="javasvn/bin">
			    <include name="org/tmatesoft/svn/cli/**"/>
			</fileset>
		</jar>
		<copy file="contrib/jsch/jsch-0.1.18.jar" todir="lib"/>
		<copy file="javasvn/cli/svn.bat" todir="lib"/>
		<copy file="javasvn/cli/svn" todir="lib"/>
		<chmod file="lib/svn" perm="ugo+rx"/>
	</target>

	<target name="build-src-jar" depends="init">
		<mkdir dir="lib"/>
		<zip destfile="lib/javasvn.src.zip">
			<fileset dir="javasvn/src">
			    <include name="**/*.java"/>
			</fileset>
			<fileset dir="javasvn-eclipse/src">
			    <include name="**/*.java"/>
			</fileset>
			<fileset dir="contrib/sequence/src">
			    <include name="**/*.java"/>
			</fileset>
			<fileset dir="contrib/javahl/src">
			    <include name="**/*.java"/>
                            <exclude name="**/SVNClient.java"/>
			</fileset>
		</zip>
	</target>

	<target name="doc">
		<mkdir dir="doc/javadoc" />
		<javadoc destdir="doc/javadoc" windowtitle="JavaDoc :: Documentation :: Pure Java Subversion (SVN) Client Library" 
			breakiterator="yes" > 
			<packageset dir="javasvn/src">
				<include name="**"/>
				<exclude name="**/internal/**"/>
			</packageset>
			<header><![CDATA[<a target="_top" href="http://tmate.org/svn/">JavaSVN&nbsp;Home<a/>]]></header>
		    <bottom><![CDATA[Copyright &#169; 2004 TMate Software Ltd. All Rights Reserved.]]></bottom>
		</javadoc>
		<copy file="www/structure.html" tofile="doc/usage.html" failonerror="false" />
		<copy file="www/build.html" tofile="doc/build.html" failonerror="false" />
		<copy file="www/subclipse.html" tofile="doc/subclipse.html" failonerror="false" />
	</target>

	<target name="build-eclipse" depends="build-standalone">
		<mkdir dir="javasvn-eclipse/bin" />
     	<path id="eclipse.class.path">
		    <pathelement path="lib/javasvn.jar"/>
		    <pathelement path="lib/jsch-0.1.18.jar"/>
		    <pathelement path="${eclipse.home}/plugins/org.eclipse.core.runtime_3.1.0/runtime.jar"/>
		    <pathelement path="${eclipse.home}/plugins/org.eclipse.osgi_3.1.0/osgi.jar"/>
	    </path>
		
		<javac debug="true" classpathref="eclipse.class.path" destdir="javasvn-eclipse/bin" >
			<src path="javasvn-eclipse/src"/>
		</javac>
		
		<!-- build plugin structure -->
		<property name="plugin.name" value="org.tmatesoft.svn.core_1.0.0"/>
		<mkdir dir="javasvn-eclipse/plugin/${plugin.name}"/>
		<mkdir dir="javasvn-eclipse/plugin/${plugin.name}/lib"/>
		<copy file="javasvn-eclipse/plugin.xml" tofile="javasvn-eclipse/plugin/${plugin.name}/plugin.xml"/>
		<copy file="lib/javasvn.jar" tofile="javasvn-eclipse/plugin/${plugin.name}/lib/javasvn.jar"/>
		<copy file="lib/jsch-0.1.18.jar" tofile="javasvn-eclipse/plugin/${plugin.name}/lib/jsch-0.1.18.jar"/>
		<copy file="copying" tofile="javasvn-eclipse/plugin/${plugin.name}/COPYING"/>
		<copy file="contrib/javahl/copying-svn" tofile="javasvn-eclipse/plugin/${plugin.name}/COPYING-SVN"/>
		<copy file="contrib/jsch/jsch-license" tofile="javasvn-eclipse/plugin/${plugin.name}/JSCH-LICENSE"/>

		<jar destfile="javasvn-eclipse/plugin/${plugin.name}/lib/svnplugin.jar">
			<fileset dir="javasvn-eclipse/bin">
			    <include name="**"/>
			</fileset>
		</jar>
		<zip destfile="javasvn-eclipse/plugin/${plugin.name}/javasvnsrc.zip">
			<fileset dir="javasvn/src">
			    <include name="**"/>
			</fileset>
			<fileset dir="javasvn-eclipse/src">
			    <include name="**"/>
			</fileset>
			<fileset dir="contrib/javahl/src">
			    <include name="**"/>
			</fileset>
			<fileset dir="contrib/sequence/src">
			    <include name="**"/>
			</fileset>
	    </zip>
	</target>
	
	<target name="deploy" depends="clean,build-eclipse,doc,build-src-jar">
		<!-- zip this folder contents -->
		<zip destfile="org.tmatesoft.svn_1.0.0_${date}.standalone.zip">
			<zipfileset dir=".">
				<include name="lib/**"/>
				<include name="changelog.txt"/>
				<include name="COPYING"/>
				<include name="doc/**"/>
			</zipfileset>
			<zipfileset dir="contrib/javahl">
				<include name="COPYING-SVN"/>
			</zipfileset>
			<zipfileset dir="contrib/jsch">
				<include name="JSCH-LICENSE"/>
			</zipfileset>
		</zip>
		<!-- zip eclipse plugin -->
		<zip basedir="javasvn-eclipse/plugin" destfile="org.tmatesoft.svn_1.0.0_${date}.eclipse.zip">
			<include name="**"/>
		</zip>
		<zip basedir="javasvn-eclipse/plugin" destfile="org.tmatesoft.svn_1.0.0_${date}.eclipse.zip">
                        <include name="**"/>
		</zip>
		<zip basedir="." destfile="org.tmatesoft.svn_1.0.0_${date}.src.zip">
			<exclude name="lib/**"/>
			<exclude name="doc/**"/>
			<exclude name="**/bin/**"/>
			<exclude name="**/bin-test/**"/>
			<exclude name="*.zip"/>
			<exclude name="javasvn-eclipse/**"/>
			<exclude name="javasvn-test/**"/>
			<exclude name="www/**"/>
                        <exclude name="**/.svn"/>
                </zip>
	</target>
	
	<target name="test" depends="build-standalone">
		<java classpath="lib/javasvn.jar;contrib/junit/junit.jar;contrib/sequence/bin-test;javasvn-test/bin" 
			  dir="javasvn-test"
			  fork="true"
			  classname="org.tmatesoft.svn.core.test.AllTests">
			<arg line="-text test.properties"/>
		</java>			 
	</target>

	<target name="help" depends="init">
		<echo message="JavaSVN ANT build file"/>
		<echo message=""/>
		<echo message="[targets]"/>
		<echo message="build-standalone builds javasvn.jar only"/>
		<echo message="deploy           builds standalone and eclipse distributions"/>
		<echo message="test             runs all tests"/>
		<echo message="test-python      runs python tests"/>
		<echo message=""/>
		<echo message="[properties]"/>
	        <echo message="OS:              ${os}"/>
        	<echo message="Eclipse:         ${eclipse.home}"/>
	        <echo message="JDK:             ${java.home}"/>
	</target>

        <target name="build" depends="build-src-jar,build-standalone"/>

        <target name="test-python" depends="build-standalone">
            <copy file="javasvn-test/python/cmdline/svntest/main.py"
                  overwrite="true"
                  tofile="javasvn-test/python/cmdline/svntest/main.py.bak"
                  failonerror="true"/>
            <copy file="javasvn-test/python/patch/main.py"
                  overwrite="true"
                  tofile="javasvn-test/python/cmdline/svntest/main.py"
                  failonerror="true"/>
	
			<java classpath="lib/javasvn.jar;contrib/junit/junit.jar;contrib/sequence/bin-test;javasvn-test/bin" 
				  dir="javasvn-test"
				  fork="true"
				  classname="org.tmatesoft.svn.core.test.PythonTests">
				<jvmarg value="-Djavasvn.log.path=%home%/.javasvn/.python.%g.%u.log"/>
				<arg line="test.properties"/>
			</java>			 
	
	        <copy file="javasvn-test/python/cmdline/svntest/main.py.bak"
	              tofile="javasvn-test/python/cmdline/svntest/main.py"
	              overwrite="true"
	              failonerror="true"/>
	       <delete file="javasvn-test/python/cmdline/svntest/main.py.bak"/>
        </target>
</project>
