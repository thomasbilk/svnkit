<html>
<head>
<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<style type='text/css'>
/*/*/ /*<![CDATA[*/
@import "file://G:/materials/Programming/SVNWorkspace/wiki/wpsrc/main.css";
#quickbar { position: absolute; left: 4px; }
#article { margin-left: 4px; margin-top: 4px; margin-right: 4px; }
a.new, #quickbar a.new { color: #CC2200; }

/*]]>*/ /* */
</style>
</head>
<body bgcolor='#FFFFFF' onload=''>
<div id="content">
<div id='article'>

<p><a href="Editing_Operation_Update.html"><<</a> | <a href="Managing_repository_With_JavaSVN.html">List</a> |  >>
<br />
<br />
</p>
<table id="toc" border="0"><tr><th>Table of contents</th></tr><tr><td><ol><li><a href="#Replicating_an_existing_repository"> Replicating an existing repository </a>
</li><li><a href="#Replicating_a_range_of_source_repository_revisions"> Replicating a range of source repository revisions </a>
</li><li><a href="#Replicating_a_source_repository_incrementally"> Replicating a source repository incrementally </a>
</li><li><a href="#Replicating_principles"> Replicating principles </a>
</li><li><a href="#Example:_replicator_in_usage"> Example: replicator in usage </a>
</li></ol></td></tr></table><hr/><a name="Replicating_an_existing_repository" id="Replicating_an_existing_repository"></a>
<h2> Replicating an existing repository </h2><p>The <span class="nobr"><a href="http://tmate.org/svn/kb/javadoc/org/tmatesoft/svn/core/replicator/package-summary.html" class="external" title="http://tmate.org/svn/kb/javadoc/org/tmatesoft/svn/core/replicator/package-summary.html">repository replicator</a></span> is a tool 
that gives you an ability to create clones of existing repositories. That is, the replicator copies revisions of existing 
repositories to other clean repositories what results in two separate repositories containing the same versioned data.
</p><p>
</p><p>
The replicator is represented by the class <span class="nobr"><a href="http://tmate.org/svn/kb/javadoc/org/tmatesoft/svn/core/replicator/SVNRepositoryReplicator.html" class="external" title="http://tmate.org/svn/kb/javadoc/org/tmatesoft/svn/core/replicator/SVNRepositoryReplicator.html">SVNRepositoryReplicator</a></span>. 
Here&#39;s a lite class diagram demonstrating relationships between the replicator and other components which are involved by 
the replicator:
</p><p><img src="Replicator_Diagram.png">
</p>
<a name="Replicating_a_range_of_source_repository_revisions" id="Replicating_a_range_of_source_repository_revisions"></a>
<h2> Replicating a range of source repository revisions </h2><p>There are two ways you can replicate repositories. The first one corresponds to using the replicator&#39;s 

</p><div class="java"><pre>
    <b><font color="#7F0055">public</font></b> <b><font color="#7F0055">long</font></b> replicateRepository(SVNRepository src, SVNRepository dst, <b><font color="#7F0055">long</font></b> fromRevision, <b><font color="#7F0055">long</font></b> toRevision) <b><font color="#7F0055">throws</font></b> SVNException 
</pre></div><p>method. 
</p><p>
</p><p>
Both source (<code>src</code>) and destination (<code>dst</code>) <b>SVNRepository</b> drivers must be created for 
the root locations of the source and destination repositories respectively. That is, only entire repository trees can be 
replicated, but not sub-trees. A destination repository must be either completely clean (be at revision 0) or must already 
contain all source repository revisions in the range starting from revision 1 and up to <code>fromRevision - 1</code> inclusvely. 
In all cases, if the destination repository latest revision is not equal to <code>fromRevision - 1</code>, you will get an exception.
</p><p>
</p><p>
If <code>fromRevision</code> is less or equal to 0, it automatically defaults to revision 1, since revision 0 is always a 
point of repository life start and doesn&#39;t contain any user valuable data. In all cases when <code>toRevision</code> is 
not in this range - <code>toRevision &gt; 0</code> and <code>toRevision &lt; </code> source repository latest revision - it 
automatically defaults to the source repository latest revision.
</p>
<a name="Replicating_a_source_repository_incrementally" id="Replicating_a_source_repository_incrementally"></a>
<h2> Replicating a source repository incrementally </h2><p>This way of replicator usage corresponds to using the replicator&#39;s 

</p><div class="java"><pre>
    <b><font color="#7F0055">public</font></b> <b><font color="#7F0055">long</font></b> replicateRepository(SVNRepository src, SVNRepository dst, <b><font color="#7F0055">boolean</font></b> incremental) <b><font color="#7F0055">throws</font></b> SVNException 
</pre></div><p>method.
</p><p>
</p><p>
<i>Incrementally</i> means that sometime you replicated the source repository into the destination one, and since then 
have committed some more revisions into the source repository. Or maybe that time you replicated not the entire range 
of the source repository revisions. And in case you would also like to copy those revisions to the destination 
repository, you perform an incremental copy - copy those missing revisions. In fact, this method is equivalent to

</p><div class="java"><pre>
    <b><font color="#7F0055">long</font></b> fromRevision = incremental ? dst.getLatestRevision() + 1 : 1;
    <b><font color="#7F0055">return</font></b> replicateRepository(src, dst, fromRevision, &#45;1);
</pre></div><p>That is, if you set <code>incremental</code> to <code>false</code> the whole source repository is replicated. Otherwise 
the source repository is incrementally copied up to the latest revision.
</p>
<a name="Replicating_principles" id="Replicating_principles"></a>
<h2> Replicating principles </h2><p>Starting with the first revision to copy the replicator obtains information about all changed paths in the particular 
revision of the source repository. This information is analysed for the presence of paths copied in that revision. Then 
the replicator obtains a <a href="Editing_Operation_Commit.html">commit editor</a> for the destination repository. This editor is 
passed to an instance of <span class="nobr"><a href="http://tmate.org/svn/kb/javadoc/org/tmatesoft/svn/core/replicator/SVNReplicationEditor.html" class="external" title="http://tmate.org/svn/kb/javadoc/org/tmatesoft/svn/core/replicator/SVNReplicationEditor.html">SVNReplicationEditor</a></span>. 
A replication editor is like a bridge between the source and destination repositories: the replicator calls an update 
operation for the same particular revision on the source driver passing it a replication editor as an <a href="Editing_Operation_Update.html">update editor</a>.
When the source driver calls the replication editor, the latter transforms these calls to calls to the commit editor of 
the destination driver. Thus changes received are <i>redirected</i> immediately to the destination repository. 
</p><p>
</p><p>
<span class="nobr"><a href="http://tmate.org/svn/kb/javadoc/org/tmatesoft/svn/core/replicator/ISVNReplicationHandler.html" class="external" title="http://tmate.org/svn/kb/javadoc/org/tmatesoft/svn/core/replicator/ISVNReplicationHandler.html">ISVNReplicationHandler</a></span> is introduced to control 
replication process. At the start of each replication iteration the replicator checks the registered handler&#39;s method 

</p><div class="java"><pre>
    <b><font color="#7F0055">public</font></b> <b><font color="#7F0055">void</font></b> checkCancelled() <b><font color="#7F0055">throws</font></b> SVNCancelException
</pre></div><p>To stop the replication process it&#39;s enough for the handler to throw an <span class="nobr"><a href="http://tmate.org/svn/kb/javadoc/org/tmatesoft/svn/core/SVNCancelException.html" class="external" title="http://tmate.org/svn/kb/javadoc/org/tmatesoft/svn/core/SVNCancelException.html">SVNCancelException</a></span> 
exception. <code>replicateRepository(...)</code> method will throw it upper.
</p><p>
</p><p>
If replication is not cancelled and a log operation is successfully perfromed for a particular revision of the source 
repository, the replicator passes this log info to the registered handler&#39;s method

</p><div class="java"><pre>
    <b><font color="#7F0055">public</font></b> <b><font color="#7F0055">void</font></b> revisionReplicating(SVNRepositoryReplicator source, SVNLogEntry logEntry) <b><font color="#7F0055">throws</font></b> SVNException
</pre></div>
<p>
</p><p>
And after the current revision is successfully committed to the destination repository the replicaor passes commit info 
to the handler&#39;s method:

</p><div class="java"><pre>
    <b><font color="#7F0055">public</font></b> <b><font color="#7F0055">void</font></b> revisionReplicated(SVNRepositoryReplicator source, SVNCommitInfo commitInfo) <b><font color="#7F0055">throws</font></b> SVNException;
</pre></div>
<p>
</p><p>
The replicator copies both versioned and unversioned (revision properties) data.
</p><p>
</p><p>
In theory, with the repository replicator you are able to create exact copies of repository contents, but in practice it 
strongly depends on permissions you have on both source and destination repositories. Say, if you are not able to read 
some directory in the source repository, it is obvious that this directory will be missing in the destination one.
</p><p>
</p><p>
You can use different repository access <a href="JavaSVN_Architecture.html">protocols supported by JavaSVN</a> for both source and 
destination repositories. This provides you an ability to make a local back-up of a repository located on the server 
machine.
</p>
<a name="Example:_replicator_in_usage" id="Example:_replicator_in_usage"></a>
<h2> Example: replicator in usage </h2><p>In this example we will replicate a local source repository to a local destination one. First we need to create and 
populate a source repository with some data. Here&#39;s a function which populates a repository with some dummy data.

</p><div class="java"><pre>
    <b><font color="#7F0055">private</font></b> <b><font color="#7F0055">static</font></b> <b><font color="#7F0055">void</font></b> populateSourceRepository(SVNRepository srcRepository) <b><font color="#7F0055">throws</font></b> SVNException &#123;
        <font color="#3F7F5F">/&#42;
         &#42; Simple repository tree to create. Each entry will be 
         &#42; added in its own revision.
         &#42;/</font>
        String dirA = <font color="#2A00FF">&#34;dirA&#34;</font>;
        String dirB = <font color="#2A00FF">&#34;dirA/dirB&#34;</font>;
        String fileA = <font color="#2A00FF">&#34;dirA/fileA.txt&#34;</font>;
        String fileB = <font color="#2A00FF">&#34;dirA/dirB/fileB.txt&#34;</font>;
        <b><font color="#7F0055">byte</font></b>&#91;&#93; fileAContents = <font color="#2A00FF">&#34;This is file fileA.txt&#34;</font>.getBytes();
        <b><font color="#7F0055">byte</font></b>&#91;&#93; fileBContents = <font color="#2A00FF">&#34;This is file fileB.txt&#34;</font>.getBytes();
        SVNDeltaGenerator deltaGenerator = <b><font color="#7F0055">new</font></b> SVNDeltaGenerator();
        <b><font color="#7F0055">long</font></b> revision = &#45;1;
        SVNCommitInfo info = <b><font color="#7F0055">null</font></b>;
        String checksum = <b><font color="#7F0055">null</font></b>;
        
        <font color="#3F7F5F">/&#42;
         &#42; First commit &#34;/dirA&#34;.
         &#42;/</font>
        ISVNEditor editor = srcRepository.getCommitEditor(<font color="#2A00FF">&#34;adding &#34;</font> + dirA, <b><font color="#7F0055">null</font></b>);
        editor.openRoot(&#45;1);
        editor.addDir(dirA, <b><font color="#7F0055">null</font></b>, &#45;1);
        editor.closeDir();
        editor.closeDir();
        info = editor.closeEdit();
        System.out.println(info);
        revision = info.getNewRevision();
        
        <font color="#3F7F5F">/&#42;
         &#42; Then commit &#34;/dirA/fileA.txt&#34;.
         &#42;/</font>
        editor = srcRepository.getCommitEditor(<font color="#2A00FF">&#34;adding &#34;</font> + fileA, <b><font color="#7F0055">null</font></b>);
        editor.openRoot(&#45;1);
        editor.openDir(dirA, revision);
        editor.addFile(fileA, <b><font color="#7F0055">null</font></b>, &#45;1);
        editor.applyTextDelta(fileA, <b><font color="#7F0055">null</font></b>);
        checksum = deltaGenerator.sendDelta(fileA, <b><font color="#7F0055">new</font></b> ByteArrayInputStream(fileAContents), editor, <b><font color="#7F0055">true</font></b>);
        editor.closeFile(fileA, checksum);
        editor.closeDir();
        editor.closeDir();
        info = editor.closeEdit();
        System.out.println(info);
        revision = info.getNewRevision();

        <font color="#3F7F5F">/&#42;
         &#42; Then commit &#34;/dirA/dirB&#34;.
         &#42;/</font>
        editor = srcRepository.getCommitEditor(<font color="#2A00FF">&#34;adding &#34;</font> + dirB, <b><font color="#7F0055">null</font></b>);
        editor.openRoot(&#45;1);
        editor.openDir(dirA, revision);
        editor.addDir(dirB, <b><font color="#7F0055">null</font></b>, &#45;1);
        editor.closeDir();
        editor.closeDir();
        editor.closeDir();
        info = editor.closeEdit();
        System.out.println(info);
        revision = info.getNewRevision();
        
        <font color="#3F7F5F">/&#42;
         &#42; Then commit &#34;/dirA/dirB/fileB.txt&#34;.
         &#42;/</font>
        editor = srcRepository.getCommitEditor(<font color="#2A00FF">&#34;adding &#34;</font> + fileB, <b><font color="#7F0055">null</font></b>);
        editor.openRoot(&#45;1);
        editor.openDir(dirA, revision);
        editor.openDir(dirB, revision);
        editor.addFile(fileB, <b><font color="#7F0055">null</font></b>, &#45;1);
        editor.applyTextDelta(fileB, <b><font color="#7F0055">null</font></b>);
        checksum = deltaGenerator.sendDelta(fileB, <b><font color="#7F0055">new</font></b> ByteArrayInputStream(fileBContents), editor, <b><font color="#7F0055">true</font></b>);
        editor.closeFile(fileB, checksum);
        editor.closeDir();
        editor.closeDir();
        editor.closeDir();
        info = editor.closeEdit();
        System.out.println(info);
    &#125;
</pre></div><p>And this function replicates the whole source repository to a target one:

</p><div class="java"><pre>
    <b><font color="#7F0055">private</font></b> <b><font color="#7F0055">static</font></b> <b><font color="#7F0055">long</font></b> replicateRepository(SVNRepository srcRepository, SVNRepository tgtRepository) <b><font color="#7F0055">throws</font></b> SVNException &#123;
        <b><font color="#7F0055">long</font></b> latestRevision = srcRepository.getLatestRevision();
        SVNRepositoryReplicator replicator = SVNRepositoryReplicator.newInstance();
        <b><font color="#7F0055">return</font></b> replicator.replicateRepository(srcRepository, tgtRepository, 1, latestRevision);
    &#125;
</pre></div><p>And this is the main program:

</p><div class="java"><pre>
<b><font color="#7F0055">public</font></b> <b><font color="#7F0055">class</font></b> Replicate &#123;

    <b><font color="#7F0055">public</font></b> <b><font color="#7F0055">static</font></b> <b><font color="#7F0055">void</font></b> main(String&#91;&#93; args) &#123;
        FSRepositoryFactory.setup();

        <font color="#3F7F5F">/&#42;
         &#42; source and target repository paths
         &#42;/</font>
        String srcPath = <font color="#2A00FF">&#34;srcRepository&#34;</font>;
        String tgtPath = <font color="#2A00FF">&#34;tgtRepository&#34;</font>;
        
        SVNURL srcURL = <b><font color="#7F0055">null</font></b>;
        SVNURL tgtURL = <b><font color="#7F0055">null</font></b>;
        SVNRepository srcRepository = <b><font color="#7F0055">null</font></b>;
        SVNRepository tgtRepository = <b><font color="#7F0055">null</font></b>;
        
        <b><font color="#7F0055">try</font></b> &#123;
            srcURL = SVNRepositoryFactory.createLocalRepository(<b><font color="#7F0055">new</font></b> File(srcPath), <b><font color="#7F0055">false</font></b>, <b><font color="#7F0055">false</font></b>);
            tgtURL = SVNRepositoryFactory.createLocalRepository(<b><font color="#7F0055">new</font></b> File(tgtPath), <b><font color="#7F0055">true</font></b>, <b><font color="#7F0055">false</font></b>);
            
            srcRepository = SVNRepositoryFactory.create(srcURL);
            tgtRepository = SVNRepositoryFactory.create(tgtURL);
        &#125; <b><font color="#7F0055">catch</font></b> (SVNException svne) &#123;
            <font color="#3F7F5F">/&#42;
             &#42; getFullMessage() will give us a full tree of SVNException 
             &#42; errors.
             &#42;/</font>
            System.err.println(<font color="#2A00FF">&#34;Can not create a repository: &#34;</font> + svne.getErrorMessage().getFullMessage());
            System.exit(1);
        &#125;

        srcRepository.setAuthenticationManager(SVNWCUtil.createDefaultAuthenticationManager());
        tgtRepository.setAuthenticationManager(SVNWCUtil.createDefaultAuthenticationManager());
        
        <b><font color="#7F0055">try</font></b>&#123;
            <font color="#3F7F5F">/&#42;
             &#42; Fills up the source repository with some data.
             &#42;/</font>
            populateSourceRepository(srcRepository);
            System.out.println();
            <b><font color="#7F0055">long</font></b> srcLatestRevision = srcRepository.getLatestRevision();
            System.out.println(<font color="#2A00FF">&#34;The latest source revision: &#34;</font> + srcLatestRevision);
            System.out.println();
            System.out.println(<font color="#2A00FF">&#34;&#39;&#34;</font> + srcURL + <font color="#2A00FF">&#34;&#39; repository tree:&#34;</font>);
            System.out.println();

            <font color="#3F7F5F">/&#42;
             &#42; Using the DisplayRepositoryTree example to show the source 
             &#42; repository tree in the latest revision. 
             &#42;/</font>
            DisplayRepositoryTree.listEntries(srcRepository, <font color="#2A00FF">&#34;&#34;</font>);
        &#125;<b><font color="#7F0055">catch</font></b>(SVNException svne)&#123;
            System.err.println(<font color="#2A00FF">&#34;An error occurred while accessing source repository: &#34;</font> + svne.getErrorMessage().getFullMessage());
            System.exit(1);
        &#125;

        <b><font color="#7F0055">try</font></b>&#123;
            <font color="#3F7F5F">/&#42;
             &#42; Replicates the source repository to the target one.
             &#42;/</font>
            <b><font color="#7F0055">long</font></b> replicatedRevisions = replicateRepository(srcRepository, tgtRepository);
            System.out.println();
            System.out.println(<font color="#2A00FF">&#34;Number of replicated revisions: &#34;</font> + replicatedRevisions);
            System.out.println();
            System.out.println(<font color="#2A00FF">&#34;&#39;&#34;</font> + tgtURL + <font color="#2A00FF">&#34;&#39; repository tree:&#34;</font>);
            System.out.println();
            <font color="#3F7F5F">/&#42;
             &#42; Shows the tree of the target repository in the latest revision.
             &#42;/</font>
            DisplayRepositoryTree.listEntries(tgtRepository, <font color="#2A00FF">&#34;&#34;</font>);
        &#125;<b><font color="#7F0055">catch</font></b>(SVNException svne)&#123;
            System.err.println(<font color="#2A00FF">&#34;An error occurred while accessing source repository: &#34;</font> + svne.getErrorMessage().getFullMessage());
            System.exit(1);
        &#125;
    &#125;
</pre></div><p>Running a program:
</p><pre> r1 by &#39;me&#39; at Wed Apr 26 02:10:14 NOVST 2006
 r2 by &#39;me&#39; at Wed Apr 26 02:10:14 NOVST 2006
 r3 by &#39;me&#39; at Wed Apr 26 02:10:15 NOVST 2006
 r4 by &#39;me&#39; at Wed Apr 26 02:10:15 NOVST 2006
   
 The latest source revision: 4
   
 &#39;file:///G:/tgtRepository&#39; repository tree:

 /dirA (author: &#39;me&#39;; revision: 4; date: Wed Apr 26 02:10:15 NOVST 2006)
 /dirA/dirB (author: &#39;me&#39;; revision: 4; date: Wed Apr 26 02:10:15 NOVST 2006)
 /dirA/dirB/fileB.txt (author: &#39;me&#39;; revision: 4; date: Wed Apr 26 02:10:15 NOVST 2006)
 /dirA/fileA.txt (author: &#39;me&#39;; revision: 2; date: Wed Apr 26 02:10:14 NOVST 2006)
   
 Number of replicated revisions: 4
 
 &#39;file:///G:/tgtRepository&#39; repository tree:

 /dirA (author: &#39;me&#39;; revision: 4; date: Wed Apr 26 02:10:15 NOVST 2006)
 /dirA/dirB (author: &#39;me&#39;; revision: 4; date: Wed Apr 26 02:10:15 NOVST 2006)
 /dirA/dirB/fileB.txt (author: &#39;me&#39;; revision: 4; date: Wed Apr 26 02:10:15 NOVST 2006)
 /dirA/fileA.txt (author: &#39;me&#39;; revision: 2; date: Wed Apr 26 02:10:14 NOVST 2006</pre><hr/><p>Download the <span class="nobr"><a href="http://svn.tmate.org/repos/jsvn/trunk/doc/examples/src/org/tmatesoft/svn/examples/repository/Replicate.java" class="external" title="http://svn.tmate.org/repos/jsvn/trunk/doc/examples/src/org/tmatesoft/svn/examples/repository/Replicate.java">example program source code</a></span>.
</p><p><br />
<br />
<a href="Editing_Operation_Update.html"><<</a> | <a href="Managing_repository_With_JavaSVN.html">List</a> |  >>

</p>   

</div>
</div>
</body>
</html>